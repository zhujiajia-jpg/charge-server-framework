# Netty实现高性能硬件通信（充电桩）

了解通信，你需要了解的各种协议，以充电桩为例，充电桩协议一般有几种：

* TCP协议
* J85385协议
* MQTT协议

### TCP

* 数据格式

  | 起始域 | 长度域 | 版本预 | 序列号 | 命令类型 | 数据域 | 校验和 |
  | ------ | ------ | ------ | ------ | -------- | ------ | ------ |
  | 2字节  | 2字节  | 1字节  | 1字节  | 2字节    | N字节  | 1字节  |
  |        |        |        |        |          |        |        |

* 起始域在Netty解析的时候能知道开始的字节，

* 长度域标识单个报文的长度，

* 数据域记录业务数据，一般编码有

  * ASSIC编码：
  * BCD编码（一般标识时间）
    * 如2022-01-28-09-58-55，表示为：0x20 0x22 0x01 0x28 0x09 0x58 0x55 0xff   总共8字节
  * 16进制编码：直接表示数字类型,注意大小端存储

* 校验和：报文安全方面考虑，校验该报文内容是否被篡改

* 安全：1、黑白名单 2、检验和

### J85385协议

* 报文格式

  | 报文头 | 报文类型 | 位图  | 数据域 |
  | ------ | -------- | ----- | ------ |
  | 8字节  | 4字节    | 8字节 | N字节  |
  |        |          |       |        |

* 报文头：包含报文重要信息，如报文长度等

* 报文类型，一般记录在j8583.xml

* 位图：8字节一共64个二进制，每个位数表示每个域，总共表示63个域，1表示数据域里面有该域数据，0表示没有

  ​        第一个二进制，为扩展数字，如果为1表示可以扩展到16字节

  ​		最后一个63个域一般表示数据中MAC校验

* 数据域：各个域的表示方式，按接口文档来

* 安全：1、MAC校验报文报文是否被篡改

  ​			2、使用对称加密算法对数据进行加密

  ​			3、使用黑白名单

* 安全流程如下：

![image-20220128103710818](C:\Users\zhujiajia\AppData\Roaming\Typora\typora-user-images\image-20220128103710818.png)

### MQTT协议

MQTT协议是对TCP协议的顶层封装，通信方式不一样。报文格式可以参考TCP协议，定长报文，

* 安全：1、使用DES对称加密 2、黑白名单
* 心跳：1、心跳报文  2、遗嘱消息订阅

MQTT通信一般使用broker\client消息订阅模式，





## 进入正题

，先上图：

### TCP协议通信架构

![image-20220128112157017](C:\Users\zhujiajia\AppData\Roaming\Typora\typora-user-images\image-20220128112157017.png)

### Mqtt协议通信架构

![image-20220128113704387](C:\Users\zhujiajia\AppData\Roaming\Typora\typora-user-images\image-20220128113704387.png)

### j8583协议通信架构

本质上J8583是一种特殊规则的TCP通信，因此和TCP一样，不同的是解析报文过程不一样



## 微服务架构中兼容不同协议

问题描述：在硬件通信tcp连接中，因app中需要实现扫码充电时功能，二维码是设备uid，前端对硬件下发充电命令时，不知道当前充电桩是连接到那个硬件服务器的，因此需要在gateway中对硬件指令进行路由。

2个解决方案：

* 充电桩不使用域名连接。需要提前维护硬件连接服务器IP

  ![image-20220128114432691](C:\Users\zhujiajia\AppData\Roaming\Typora\typora-user-images\image-20220128114432691.png)

* 充电桩使用域名连接

  ![image-20220128114505332](C:\Users\zhujiajia\AppData\Roaming\Typora\typora-user-images\image-20220128114505332.png)